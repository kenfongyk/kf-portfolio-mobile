<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0d1117">
    <title>KF Portfolio Mobile</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border: #30363d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-amber: #d29922;
            --accent-blue: #58a6ff;
            --accent-purple: #a371f7;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header .sync-info {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .refresh-btn {
            background: var(--accent-blue);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .refresh-btn:active {
            transform: scale(0.95);
        }
        
        /* Summary Cards */
        .summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 12px;
        }
        
        .summary-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .summary-card .region {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        
        .summary-card .value {
            font-size: 16px;
            font-weight: 700;
        }
        
        .summary-card .pl {
            font-size: 13px;
            margin-top: 4px;
        }
        
        .positive { color: var(--accent-green); }
        .negative { color: var(--accent-red); }
        
        /* Tabs */
        .tabs {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 56px;
            z-index: 99;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab.active {
            color: var(--accent-blue);
            border-bottom-color: var(--accent-blue);
        }
        
        .tab .count {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 4px;
        }
        
        /* Content */
        .content {
            padding: 12px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Stock Cards */
        .stock-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            position: relative;
        }
        
        .stock-card.alert-buy {
            border-left: 4px solid var(--accent-green);
        }
        
        .stock-card.alert-sell {
            border-left: 4px solid var(--accent-red);
        }
        
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .stock-name {
            font-weight: 600;
            font-size: 15px;
        }
        
        .stock-ticker {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .stock-price {
            text-align: right;
        }
        
        .stock-price .current {
            font-size: 18px;
            font-weight: 700;
        }
        
        .stock-price .change {
            font-size: 13px;
        }
        
        .stock-details {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            font-size: 12px;
        }
        
        .detail-item {
            background: var(--bg-tertiary);
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        
        .detail-item .label {
            color: var(--text-muted);
            font-size: 10px;
            margin-bottom: 2px;
        }
        
        .detail-item .value {
            font-weight: 600;
            font-size: 13px;
        }
        
        /* Alerts Badge */
        .alert-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
        }
        
        .alert-badge.buy {
            background: rgba(63, 185, 80, 0.2);
            color: var(--accent-green);
        }
        
        .alert-badge.sell {
            background: rgba(248, 81, 73, 0.2);
            color: var(--accent-red);
        }
        
        /* Alerts Tab */
        .alert-section {
            margin-bottom: 20px;
        }
        
        .alert-section h3 {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }
        
        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        /* Settings */
        .settings-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .settings-section label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .settings-section input {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .settings-section small {
            display: block;
            margin-top: 6px;
            color: var(--text-muted);
            font-size: 11px;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }
        
        .btn-primary {
            background: var(--accent-blue);
            color: white;
        }
        
        .btn-success {
            background: var(--accent-green);
            color: white;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Signal badges */
        .signal {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
        }
        
        .signal-buy { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
        .signal-sell { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        .signal-hold { background: rgba(210, 153, 34, 0.2); color: var(--accent-amber); }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üìä KF Portfolio</h1>
            <div class="sync-info" id="syncInfo">Last sync: Never</div>
        </div>
        <button class="refresh-btn" onclick="refreshData()">
            üîÑ Refresh
        </button>
    </div>
    
    <div class="summary" id="summary">
        <div class="summary-card">
            <div class="region">üá∫üá∏ USA</div>
            <div class="value" id="usaValue">‚Äî</div>
            <div class="pl" id="usaPL">‚Äî</div>
        </div>
        <div class="summary-card">
            <div class="region">üá∏üá¨ SG</div>
            <div class="value" id="sgValue">‚Äî</div>
            <div class="pl" id="sgPL">‚Äî</div>
        </div>
        <div class="summary-card">
            <div class="region">üá≠üá∞ HK</div>
            <div class="value" id="hkValue">‚Äî</div>
            <div class="pl" id="hkPL">‚Äî</div>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab active" data-tab="portfolio" onclick="switchTab('portfolio')">
            üíº Portfolio <span class="count" id="portfolioCount">0</span>
        </button>
        <button class="tab" data-tab="watchlist" onclick="switchTab('watchlist')">
            üëÅÔ∏è Watch <span class="count" id="watchCount">0</span>
        </button>
        <button class="tab" data-tab="alerts" onclick="switchTab('alerts')">
            üö® Alerts <span class="count" id="alertCount">0</span>
        </button>
        <button class="tab" data-tab="settings" onclick="switchTab('settings')">
            ‚öôÔ∏è
        </button>
    </div>
    
    <div class="content">
        <!-- Portfolio Tab -->
        <div class="tab-content active" id="tab-portfolio">
            <div class="loading" id="portfolioLoading">
                <div class="spinner"></div>
                <p>Loading portfolio...</p>
            </div>
            <div id="portfolioList"></div>
        </div>
        
        <!-- Watchlist Tab -->
        <div class="tab-content" id="tab-watchlist">
            <div id="watchlistList"></div>
        </div>
        
        <!-- Alerts Tab -->
        <div class="tab-content" id="tab-alerts">
            <div id="alertsList"></div>
        </div>
        
        <!-- Settings Tab -->
        <div class="tab-content" id="tab-settings">
            <div class="settings-section">
                <label>GitHub Gist URL</label>
                <input type="text" id="gistUrl" placeholder="https://gist.githubusercontent.com/...">
                <small>Get this from your Gist ‚Üí Raw URL of portfolio_sync.json</small>
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">üíæ Save Settings</button>
            <button class="btn btn-success" onclick="refreshData()" style="margin-top:8px;">üîÑ Test Connection</button>
        </div>
    </div>
    
    <script>
        // ============================================================
        // CONFIG
        // ============================================================
        const STORAGE_KEY = 'kf_mobile_config';
        const CACHE_KEY = 'kf_portfolio_cache';
        
        let portfolioData = null;
        let priceCache = {};
        
        // ============================================================
        // INITIALIZATION
        // ============================================================
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadCachedData();
            refreshData();
        });
        
        function loadSettings() {
            const config = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            if (config.gistUrl) {
                document.getElementById('gistUrl').value = config.gistUrl;
            }
        }
        
        function saveSettings() {
            const gistUrl = document.getElementById('gistUrl').value.trim();
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ gistUrl }));
            alert('‚úÖ Settings saved!');
        }
        
        function loadCachedData() {
            const cached = localStorage.getItem(CACHE_KEY);
            if (cached) {
                try {
                    portfolioData = JSON.parse(cached);
                    renderAll();
                } catch(e) {}
            }
        }
        
        // ============================================================
        // DATA FETCHING
        // ============================================================
        async function refreshData() {
            const config = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
            
            if (!config.gistUrl) {
                switchTab('settings');
                alert('Please configure your Gist URL in Settings first.');
                return;
            }
            
            document.getElementById('portfolioLoading').style.display = 'block';
            
            try {
                // Add cache-busting parameter
                const url = config.gistUrl + '?t=' + Date.now();
                const response = await fetch(url);
                
                if (!response.ok) throw new Error('Failed to fetch');
                
                portfolioData = await response.json();
                localStorage.setItem(CACHE_KEY, JSON.stringify(portfolioData));
                
                document.getElementById('syncInfo').textContent = 'Synced: ' + new Date(portfolioData.exported_at).toLocaleString();
                
                // Fetch live prices
                await fetchLivePrices();
                
                renderAll();
            } catch(e) {
                alert('‚ùå Error loading data: ' + e.message);
            }
            
            document.getElementById('portfolioLoading').style.display = 'none';
        }
        
        async function fetchLivePrices() {
            if (!portfolioData) return;
            
            const allTickers = [
                ...portfolioData.portfolio.map(p => ({ ticker: p.ticker, region: p.region })),
                ...portfolioData.watchlist.map(w => ({ ticker: w.ticker, region: guessRegion(w.ticker) }))
            ];
            
            // Use Yahoo Finance API via a proxy or direct call
            for (const item of allTickers) {
                try {
                    const symbol = formatYahooSymbol(item.ticker, item.region);
                    // Using a simple approach - in production, batch these calls
                    const response = await fetch(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`);
                    const data = await response.json();
                    
                    if (data.chart?.result?.[0]?.meta) {
                        const meta = data.chart.result[0].meta;
                        const quote = data.chart.result[0].indicators?.quote?.[0];
                        priceCache[item.ticker] = {
                            price: meta.regularMarketPrice,
                            prevClose: meta.previousClose,
                            change: meta.regularMarketPrice - meta.previousClose,
                            changePct: ((meta.regularMarketPrice - meta.previousClose) / meta.previousClose) * 100
                        };
                    }
                } catch(e) {
                    console.log('Price fetch failed for', item.ticker);
                }
            }
        }
        
        function formatYahooSymbol(ticker, region) {
            if (region === 'hk' || /^\d{4,5}$/.test(ticker)) {
                return ticker.replace('.HK', '').padStart(4, '0') + '.HK';
            } else if (region === 'sg') {
                return ticker.endsWith('.SI') ? ticker : ticker + '.SI';
            }
            return ticker;
        }
        
        function guessRegion(ticker) {
            if (/^\d{4,5}$/.test(ticker) || ticker.includes('.HK')) return 'hk';
            if (ticker.includes('.SI')) return 'sg';
            return 'usa';
        }
        
        // ============================================================
        // RENDERING
        // ============================================================
        function renderAll() {
            if (!portfolioData) return;
            
            renderSummary();
            renderPortfolio();
            renderWatchlist();
            renderAlerts();
            updateCounts();
        }
        
        function renderSummary() {
            const summary = portfolioData.summary || {};
            
            // USA
            const usaMkt = summary.usa?.mkt || 0;
            const usaPL = summary.usa?.pl || 0;
            document.getElementById('usaValue').textContent = '$' + usaMkt.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('usaPL').innerHTML = `<span class="${usaPL >= 0 ? 'positive' : 'negative'}">${usaPL >= 0 ? '+' : ''}$${usaPL.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>`;
            
            // SG
            const sgMkt = summary.sg?.mkt || 0;
            const sgPL = summary.sg?.pl || 0;
            document.getElementById('sgValue').textContent = '$' + sgMkt.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('sgPL').innerHTML = `<span class="${sgPL >= 0 ? 'positive' : 'negative'}">${sgPL >= 0 ? '+' : ''}$${sgPL.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>`;
            
            // HK
            const hkMkt = summary.hk?.mkt || 0;
            const hkPL = summary.hk?.pl || 0;
            document.getElementById('hkValue').textContent = '$' + hkMkt.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('hkPL').innerHTML = `<span class="${hkPL >= 0 ? 'positive' : 'negative'}">${hkPL >= 0 ? '+' : ''}$${hkPL.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>`;
        }
        
        function renderPortfolio() {
            const list = document.getElementById('portfolioList');
            
            if (!portfolioData.portfolio?.length) {
                list.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>No portfolio data</p></div>';
                return;
            }
            
            list.innerHTML = portfolioData.portfolio.map(p => {
                const price = priceCache[p.ticker]?.price || 0;
                const changePct = priceCache[p.ticker]?.changePct || 0;
                const mktVal = price ? p.qty * price : p.qty * p.cost;
                const plAmt = price ? (price - p.cost) * p.qty : 0;
                const plPct = p.cost > 0 ? ((price || p.cost) - p.cost) / p.cost * 100 : 0;
                
                // Check alerts
                let alertClass = '';
                let alertBadge = '';
                if (p.sell_target && price >= p.sell_target) {
                    alertClass = 'alert-sell';
                    alertBadge = '<div class="alert-badge sell">üî¥ SELL TARGET</div>';
                }
                
                const curr = p.currency === 'HKD' ? 'HK$' : p.currency === 'SGD' ? 'S$' : '$';
                
                return `
                    <div class="stock-card ${alertClass}">
                        ${alertBadge}
                        <div class="stock-header">
                            <div>
                                <div class="stock-name">${p.name}</div>
                                <div class="stock-ticker">${p.ticker} ‚Ä¢ ${p.platform}</div>
                            </div>
                            <div class="stock-price">
                                <div class="current ${changePct >= 0 ? 'positive' : 'negative'}">${curr}${price ? price.toFixed(2) : '‚Äî'}</div>
                                <div class="change ${changePct >= 0 ? 'positive' : 'negative'}">${changePct >= 0 ? '+' : ''}${changePct.toFixed(2)}%</div>
                            </div>
                        </div>
                        <div class="stock-details">
                            <div class="detail-item">
                                <div class="label">QTY</div>
                                <div class="value">${p.qty.toLocaleString()}</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">COST</div>
                                <div class="value">${p.cost.toFixed(2)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">MKT VAL</div>
                                <div class="value">${curr}${mktVal.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">P/L</div>
                                <div class="value ${plAmt >= 0 ? 'positive' : 'negative'}">${plAmt >= 0 ? '+' : ''}${plAmt.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderWatchlist() {
            const list = document.getElementById('watchlistList');
            
            if (!portfolioData.watchlist?.length) {
                list.innerHTML = '<div class="empty-state"><div class="icon">üëÅÔ∏è</div><p>No watchlist items</p></div>';
                return;
            }
            
            list.innerHTML = portfolioData.watchlist.map(w => {
                const price = priceCache[w.ticker]?.price || 0;
                const changePct = priceCache[w.ticker]?.changePct || 0;
                
                // Check if below buy target
                let alertClass = '';
                let alertBadge = '';
                if (w.target_price && price && price <= w.target_price) {
                    alertClass = 'alert-buy';
                    alertBadge = '<div class="alert-badge buy">üü¢ BUY TARGET</div>';
                }
                
                const curr = w.currency === 'HKD' ? 'HK$' : w.currency === 'USD' ? '$' : 'S$';
                
                return `
                    <div class="stock-card ${alertClass}">
                        ${alertBadge}
                        <div class="stock-header">
                            <div>
                                <div class="stock-name">${w.name}</div>
                                <div class="stock-ticker">${w.ticker}</div>
                            </div>
                            <div class="stock-price">
                                <div class="current ${changePct >= 0 ? 'positive' : 'negative'}">${curr}${price ? price.toFixed(2) : '‚Äî'}</div>
                                <div class="change ${changePct >= 0 ? 'positive' : 'negative'}">${changePct >= 0 ? '+' : ''}${changePct.toFixed(2)}%</div>
                            </div>
                        </div>
                        <div class="stock-details">
                            <div class="detail-item" style="grid-column: span 2;">
                                <div class="label">BUY TARGET</div>
                                <div class="value">${w.target_price ? curr + w.target_price.toFixed(2) : '‚Äî'}</div>
                            </div>
                            <div class="detail-item" style="grid-column: span 2;">
                                <div class="label">PLATFORM</div>
                                <div class="value">${w.target_platform || '‚Äî'}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderAlerts() {
            const list = document.getElementById('alertsList');
            const alerts = [];
            
            // Check portfolio for sell alerts
            portfolioData.portfolio?.forEach(p => {
                const price = priceCache[p.ticker]?.price;
                if (p.sell_target && price && price >= p.sell_target) {
                    alerts.push({
                        type: 'sell',
                        ticker: p.ticker,
                        name: p.name,
                        message: `Price ${price.toFixed(2)} ‚â• Target ${p.sell_target.toFixed(2)}`,
                        icon: 'üî¥'
                    });
                }
                
                // P/L alerts
                const plPct = price ? ((price - p.cost) / p.cost) * 100 : 0;
                if (plPct <= -10) {
                    alerts.push({
                        type: 'warning',
                        ticker: p.ticker,
                        name: p.name,
                        message: `Loss: ${plPct.toFixed(1)}%`,
                        icon: '‚ö†Ô∏è'
                    });
                } else if (plPct >= 20) {
                    alerts.push({
                        type: 'profit',
                        ticker: p.ticker,
                        name: p.name,
                        message: `Profit: +${plPct.toFixed(1)}%`,
                        icon: 'üí∞'
                    });
                }
            });
            
            // Check watchlist for buy alerts
            portfolioData.watchlist?.forEach(w => {
                const price = priceCache[w.ticker]?.price;
                if (w.target_price && price && price <= w.target_price) {
                    alerts.push({
                        type: 'buy',
                        ticker: w.ticker,
                        name: w.name,
                        message: `Price ${price.toFixed(2)} ‚â§ Target ${w.target_price.toFixed(2)}`,
                        icon: 'üü¢'
                    });
                }
            });
            
            if (alerts.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="icon">‚ú®</div><p>No alerts at this time</p></div>';
                return;
            }
            
            list.innerHTML = alerts.map(a => `
                <div class="stock-card ${a.type === 'buy' ? 'alert-buy' : a.type === 'sell' ? 'alert-sell' : ''}">
                    <div class="stock-header">
                        <div>
                            <div class="stock-name">${a.icon} ${a.name}</div>
                            <div class="stock-ticker">${a.ticker}</div>
                        </div>
                    </div>
                    <div style="color: var(--text-secondary); font-size: 13px;">${a.message}</div>
                </div>
            `).join('');
            
            document.getElementById('alertCount').textContent = alerts.length;
        }
        
        function updateCounts() {
            document.getElementById('portfolioCount').textContent = portfolioData.portfolio?.length || 0;
            document.getElementById('watchCount').textContent = portfolioData.watchlist?.length || 0;
        }
        
        // ============================================================
        // TAB SWITCHING
        // ============================================================
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            
            // Update content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
        }
    </script>
</body>
</html>
